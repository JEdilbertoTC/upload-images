<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./icon.ico">
    <title>Evidencias Fotográficas FF.CC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        #preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        #preview img {
            width: 100%;
            height: auto;
            object-fit: cover;
            max-height: 100px;
        }

        #addImageButton,
        #generatePdfButton {
            display: inline-block;
            margin: 10px 0;
            padding: 10px 20px;
            background-color: #007BFF;
            color: #FFFFFF;
            border: none;
            cursor: pointer;
        }

        #addImageButton:disabled {
            background-color: #CCCCCC;
            cursor: not-allowed;
        }

        #logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        .spinner-border {
            display: none;
            width: 3rem;
            height: 3rem;
            position: fixed;
            top: 50%;
            left: 50%;
            z-index: 1000;
        }
        table, tr, td {
            outline: 1px solid #000;
            padding: 5px;
        }
    </style>
</head>

<body>
    <div class="spinner-border" role="status" id="spinner">
        <span class="sr-only">Loading...</span>
    </div>

    <img id="logo" src="https://www.integrity-la.com/wp-content/uploads/2016/10/Logo_Cemento_Moctezuma.png"
        alt="Logo Cementos Moctezuma">
    <br>
    <h1>Evidencias Fotográficas FF.CC</h1>

    <label for="matricula">
        Matricula:
        <select id="matricula" name="matricula">
            <option value=""></option>
            <option value="ACFX">ACFX</option>
            <option value="AOKX">AOKX</option>
            <option value="BAEX">BAEX</option>
            <option value="FSRR">FSRR</option>
            <option value="FURX">FURX</option>
            <option value="FXE">FXE</option>
            <option value="ITLX">ITLX</option>
            <option value="KCS">KCS</option>
            <option value="KCSM">KCSM</option>
            <option value="NADX">NADX</option>
            <option value="NAHX">NAHX</option>
            <option value="PLWX">PLWX</option>
            <option value="RBOX">RBOX</option>
            <option value="WFRX">WFRX</option>
        </select>

    </label>
    <label for="placa">
        Placa furgón:
        <input type="text" id="placa" name="placa" />
    </label>
    <label for="fecha">
        Fecha:
        <input type="date" id="fecha" name="fecha" />
    </label>
    <label for="reporte">
        Reporte:
        <select id="reporte" name="reporte">
            <option value=""></option>
            <option value="Despacho">Despacho</option>
            <option value="Recepción">Recepción</option>
        </select>
    </label>
    <label for="ubicacion">
        Ubicación:
        <select id="ubicacion" name="ubicacion">
            <option value=""></option>
            <option value="APZ">APZ</option>
            <option value="CRT">CRT</option>
        </select>
    </label>

    <table>
        <tr>
            <td>Tarima (PZA)</td>
            <td><input type="text" id="tarima"></td>
        </tr>
        <tr>
            <td>Casetón 20 (PZA)</td>
            <td><input type="text" id="caseton20"></td>
        </tr>
        <tr>
            <td>Casetón 30 (PZA)</td>
            <td><input type="text" id="caseton30"></td>
        </tr>
        <tr>
            <td>Hebillas (PZA)</td>
            <td><input type="text" id="hebillas"></td>
        </tr>
        <tr>
            <td>Deslizable(PZA)</td>
            <td><input type="text" id="deslizable"></td>
        </tr>
        <tr>
            <td>Fleje (MTS)</td>
            <td><input type="text" id="fleje"></td>
        </tr>
    </table>

    <input type="file" id="imageUpload" accept="image/*" multiple style="display:none">
    <button id="addImageButton">Agregar Imagen</button>
    <div id="preview"></div>
    <button id="generatePdfButton">Generar PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;

        const maxNumberOfImages = 12;
        const preview = document.getElementById('preview');
        const imageUpload = document.getElementById('imageUpload');
        const addImageButton = document.getElementById('addImageButton');
        const generatePdfButton = document.getElementById('generatePdfButton');
        const images = [];
        const placaInput = document.getElementById('placa');
        const fechaInput = document.getElementById('fecha');
        const reporteInput = document.getElementById('reporte');
        const matriculaInput = document.getElementById('matricula');
        const ubicacionInput = document.getElementById('ubicacion');
        const spinner = document.getElementById('spinner');
        const tarimaInput = document.getElementById('tarima');
        const caseton20Input = document.getElementById('caseton20');
        const caseton30Input = document.getElementById('caseton30');
        const hebillasInput = document.getElementById('hebillas');
        const deslizableInput = document.getElementById('deslizable');
        const flejeInput = document.getElementById('fleje');

        const logo = './logo.png';
        addImageButton.addEventListener('click', () => {
            if (images.length >= maxNumberOfImages) {
                alert('Solo puedes subir un máximo de 6 imágenes');
                return;
            }
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            const maxFiles = maxNumberOfImages - images.length;

            for (let i = 0; i < Math.min(files.length, maxFiles); i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                    images.push(e.target.result);
                    if (images.length >= maxNumberOfImages) {
                        addImageButton.disabled = true;
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        generatePdfButton.addEventListener('click', () => {
            showSpinner();
            setTimeout(async () => {
                await generatePDF();
                hideSpinner();
            }, 1000);
        });

        async function generatePDF() {
            const placa = placaInput.value;
            const fecha = fechaInput.value;
            const reporte = reporteInput.value;
            const ubicacion = ubicacionInput.value;
            const matricula = matriculaInput.value;
            const tarima = tarimaInput.value;
            const caseton20 = caseton20Input.value;
            const caseton30 = caseton30Input.value;
            const hebillas = hebillasInput.value;
            const deslizable = deslizableInput.value;
            const fleje = flejeInput.value;

            if (images.length === 0) {
                alert('Por favor, sube al menos una imagen');
                return;
            }

            if (
                !placa.length ||
                !fecha.length ||
                !reporte.length ||
                !ubicacion.length ||
                !matricula.length ||
                !tarima.length ||
                !caseton20.length ||
                !caseton30.length ||
                !hebillas.length ||
                !deslizable.length ||
                !fleje.length
            ) {
                alert('Por favor, completa todos los campos');
                return;
            }

            const fileName = `${matricula}_${placa}_${fecha}_${reporte}_${ubicacion}`;

            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const imageWidth = (pageWidth - margin * 3) / 2;
            const imageHeight = (pageHeight - margin * 4 - 20) / 3;
            const logoWidth = 30;
            const logoHeight = 10;
            let x = margin / 2 + pageWidth / 2;
            let y = margin + logoHeight;

            const addLogo = () => {
                pdf.addImage(logo, 'PNG', margin, margin, logoWidth, logoHeight);
            };

            const addTable = () => {
                pdf.setFontSize(10);
                pdf.text('Tarima (PZA):', margin, y + 5);
                pdf.text(tarima, pageWidth / 4, y + 5);
                pdf.text('Casetón 20 (PZA):', margin, y + 10);
                pdf.text(caseton20, pageWidth / 4, y + 10);
                pdf.text('Casetón 30 (PZA):', margin, y + 15);
                pdf.text(caseton30, pageWidth / 4, y + 15);
                pdf.text('Hebillas (PZA):', margin, y + 20);
                pdf.text(hebillas, pageWidth / 4, y + 20);
                pdf.text('Deslizable (PZA):', margin, y + 25);
                pdf.text(deslizable, pageWidth / 4, y + 25);
                pdf.text('Fleje (MTS):', margin, y + 30);
                pdf.text(fleje, pageWidth / 4, y + 30);
            };

            addLogo();

            const total = images.length;
            for (let i = 0; i < images.length + 1; i++) {
                if(i === 0) {
                    addTable();
                    continue;
                }
                if (i % 2 === 0 && i !== 0) {
                    x = margin;
                    y += imageHeight + margin;
                } else if (i % 2 !== 0) {
                    x = pageWidth / 2 + margin / 2;
                }

                if (i > 0 && i % 6 === 0) {
                    pdf.addPage();
                    addLogo();
                    x = margin;
                    y = margin + logoHeight;
                }

                pdf.addImage(images[i - 1], 'JPEG', x, y, imageWidth, imageHeight);
            }

            const currentDate = new Date().toLocaleDateString();

            const signatureY = pageHeight - 10;
            pdf.text(fileName.toUpperCase(), pageWidth / 2, signatureY, { align: 'center' });

            pdf.save(`${fileName.toUpperCase()}.pdf`);
            preview.innerHTML = '';
            images.length = 0;
            addImageButton.disabled = false;
            placa.value = '';
            fecha.value = '';
            reporte.value = '';
            ubicacion.value = '';
            matricula.value = '';
        }

        function showSpinner() {
            spinner.style.display = 'block';
        }

        function hideSpinner() {
            spinner.style.display = 'none';
        }

    </script>
</body>

</html>
